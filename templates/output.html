{% extends "base.html" %}

{% block title %}יומן פגישות, פלט{% endblock %}

{% block content %}
  <div class="card">

    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:14px;">
      <div>
        <h1 style="margin:0;">{{ title_text if title_text else "רשימת פגישות" }}</h1>
        <div class="helper" style="margin-top:6px;">
          צפייה וניהול פגישות
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <a class="btn btn-primary" href="/input">הוסף פגישה</a>
        <a class="btn btn-secondary" href="/output">הרשימה שלי</a>
        <a class="btn btn-secondary" href="/">בחירת דיזיין</a>

        <span class="status">
          דיזיין נוכחי
          {% if theme_name == "enterprise" %}
            1
          {% elif theme_name == "soft" %}
            2
          {% elif theme_name == "pro" %}
            3
          {% elif theme_name == "mobile" %}
            4
          {% else %}
            1
          {% endif %}
        </span>
      </div>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="helper" style="margin-bottom:12px;color:var(--warning);">
          {{ messages[0] }}
        </div>
      {% endif %}
    {% endwith %}

    {% if appointments|length == 0 %}
      <div class="helper" style="text-align:center;color:var(--error);padding:18px 0;">
        אין פגישות שמורות
      </div>
    {% else %}
      <div style="overflow:auto;">
        <table class="table">
          <thead>
            <tr>
              <th>מזהה</th>
              <th>נושא</th>
              <th>תאריך</th>
              <th>שעה</th>
              <th>מיקום</th>
              <th>הערות</th>
              <th>סטטוס</th>
              <th>עודכן לאחרונה</th>
              <th>עדכון סטטוס אחרון</th>
              <th>מי עדכן סטטוס</th>
              {% if show_owner_column %}
                <th>בעלים</th>
              {% endif %}
              <th>פעולות</th>
            </tr>
          </thead>
          <tbody>
            {% for a in appointments %}
              <tr>
                <td>{{ a.id }}</td>
                <td>{{ a.title }}</td>
                <td>{{ a.date }}</td>
                <td>{{ a.time }}</td>
                <td>{{ a.location }}</td>
                <td style="max-width:320px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                  {{ a.notes }}
                </td>
                <td>
                  {% if a.status == "planned" %}
                    <span class="status status-warning">מתוכנן</span>
                  {% elif a.status == "done" %}
                    <span class="status status-success">הושלם</span>
                  {% elif a.status == "canceled" %}
                    <span class="status status-error">בוטל</span>
                  {% else %}
                    <span class="status">{{ a.status }}</span>
                  {% endif %}
                </td>
                <td>{{ a.updated_at_text }}</td>
                <td>{{ a.status_updated_at_text }}</td>
                <td>{{ a.status_updated_by_email }}</td>
                {% if show_owner_column %}
                  <td>{{ a.owner_email }}</td>
                {% endif %}
                <td>
                  <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">

                    {% if can_change_status %}
                      <a class="btn btn-secondary" href="/status/{{ a.id }}?next={{ current_path }}">שנה סטטוס</a>
                    {% endif %}

                    {% if can_manage_fields %}
                      {% if a.status != "done" %}
                        <form method="post" action="/complete/{{ a.id }}" style="margin:0;">
                          <button class="btn btn-secondary" type="submit">סמן כהושלמה</button>
                        </form>
                      {% endif %}

                      <a class="btn btn-secondary" href="/edit/{{ a.id }}">ערוך</a>

                      <form method="post" action="/delete/{{ a.id }}" style="margin:0;" onsubmit="return confirm('האם למחוק את הפגישה הזו?');">
                        <button class="btn btn-secondary" type="submit" style="background:var(--error);color:white;">מחק</button>
                      </form>
                    {% endif %}

                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

  </div>
{% endblock %}
